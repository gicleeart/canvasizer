name: Artwork to AR (GLB + USDZ)

on:
  repository_dispatch:
    types: [canvasizer_trigger]

jobs:
  build-ar:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Blender
        run: brew install --cask blender

      - name: Download artwork
        run: |
          mkdir -p assets scripts output
          curl -L "${{ github.event.client_payload.image_url }}" -o assets/artwork.png

      # ðŸªª Preflight: check environment and inputs
      - name: Preflight debug
        run: |
          set -euxo pipefail
          pwd
          ls -la
          echo "Tree before conversion:"
          find . -maxdepth 3 -type f

      - name: Create Blender script
        run: |
          cat > scripts/make_ar_plane.py << 'PY'
          ... your existing Python script ...
          PY

      - name: Run Blender headless
        run: /Applications/Blender.app/Contents/MacOS/Blender -b -noaudio --python scripts/make_ar_plane.py

      # ðŸ“¦ Stage and normalize artifacts
      - name: Normalize and stage artifacts
        run: |
          set -euxo pipefail
          mkdir -p public_models
          shopt -s nullglob
          for f in output/*.{glb,GLB,usdz,USDZ}; do
            base=$(basename "$f"); lower="${base,,}"
            cp -v "$f" "public_models/$lower"
          done
          ls -la public_models

      - name: Upload AR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artwork-ar
          path: public_models/*

      - name: Commit artifacts to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public_models
          git commit -m "Add AR models for ${{ github.event.client_payload.title }}" || echo "No changes to commit"
          git push

      - name: ðŸ”” POST back to WordPress
        env:
          WP_WEBHOOK_URL: ${{ secrets.WP_WEBHOOK_URL }}
          WP_WEBHOOK_TOKEN: ${{ secrets.WP_WEBHOOK_TOKEN }}
        run: |
          GLB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/public_models/artwork.glb"
          USDZ_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/public_models/artwork.usdz"

          echo "POSTing to: $WP_WEBHOOK_URL"
          curl -v -X POST "$WP_WEBHOOK_URL" \
            -H "Authorization: Bearer $WP_WEBHOOK_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- <<JSON
          {
            "post_id": "${{ github.event.client_payload.post_id }}",
            "title": "${{ github.event.client_payload.title }}",
            "image_url": "${{ github.event.client_payload.image_url }}",
            "glb_url": "$GLB_URL",
            "usdz_url": "$USDZ_URL"
          }
          JSON
