name: Artwork to AR (GLB + USDZ)

on:
Â  repository_dispatch:
Â  Â  types: [canvasizer_trigger]

permissions:
Â  contents: write

jobs:
Â  build-ar:
Â  Â  runs-on: macos-latest
Â  Â  steps:
Â  Â  Â  - uses: actions/checkout@v4

Â  Â  Â  - name: Cache Blender
Â  Â  Â  Â  uses: actions/cache@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: blender
Â  Â  Â  Â  Â  key: blender-macos-4.2.0

Â  Â  Â  - name: Download Blender manually (if not cached)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  mkdir -p blender
Â  Â  Â  Â  Â  if [ ! -f blender/Blender.app/Contents/MacOS/Blender ]; then
Â  Â  Â  Â  Â  Â  echo "â¬‡ï¸ Downloading Blender 4.2.0..."
Â  Â  Â  Â  Â  Â  curl -L https://mirror.clarkson.edu/blender/release/Blender4.2/blender-4.2.0-macos-x64.dmg -o blender/blender.dmg
Â  Â  Â  Â  Â  Â  hdiutil attach blender/blender.dmg -mountpoint /Volumes/Blender
Â  Â  Â  Â  Â  	cp -R "/Volumes/Blender/Blender.app" blender/
Â  Â  Â  Â  Â  	hdiutil detach /Volumes/Blender
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  	echo "âœ… Blender already cached"
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Download artwork
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  mkdir -p assets scripts output
Â  Â  Â  Â  Â  curl -L "${{ github.event.client_payload.image_url }}" -o assets/artwork.png

Â  Â  Â  - name: Convert artwork to JPEG for maximum compatibility
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  sips -s format jpeg assets/artwork.png --out assets/artwork.jpg

Â  Â  Â  - name: Create Blender script
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cat > scripts/make_ar_plane.py << 'PY'
Â  Â  Â  Â  Â  import bpy
Â  Â  Â  Â  Â  import os
Â  Â  Â  Â  Â  import math

Â  Â  Â  Â  Â  img_path = os.environ["ARIP_IMAGE_PATH"]
Â  Â  Â  Â  Â  out_glbÂ  = os.environ["ARIP_OUT_GLB"]
Â  Â  Â  Â  Â  out_usdz = os.environ["ARIP_OUT_USDZ"]
Â  Â  Â  Â  Â  os.makedirs(os.path.dirname(out_glb), exist_ok=True)
Â  Â  Â  Â  Â  os.makedirs(os.path.dirname(out_usdz), exist_ok=True)
Â  Â  Â  Â  Â  bpy.ops.wm.read_factory_settings(use_empty=True)

Â  Â  Â  Â  Â  img = bpy.data.images.load(img_path)
Â  Â  Â  Â  Â  img.colorspace_settings.name = "sRGB"

Â  Â  Â  Â  Â  width_m = 1.50
Â  Â  Â  Â  Â  depth_m = 0.02
Â  Â  Â  Â  Â  aspect_ratio = (img.size[0] / img.size[1]) if img.size[1] > 0 else 1.0
Â  Â  Â  Â  Â  height_m = width_m / aspect_ratio

Â  Â  Â  Â  Â  bpy.ops.mesh.primitive_plane_add(size=1.0, enter_editmode=False, location=(0, 0, 0))
Â  Â  Â  Â  Â  panel = bpy.context.active_object
Â  Â  Â  Â  Â  panel.name = "ArtPanel"

Â  Â  Â  Â  Â  mod = panel.modifiers.new(name="Solidify", type='SOLIDIFY')
Â  Â  Â  Â  Â  mod.thickness = depth_m
Â  Â  Â  Â  Â  mod.offset = 1.0
Â  Â  Â  Â  Â  bpy.ops.object.modifier_apply(modifier=mod.name)
Â  Â  Â  Â  Â  panel.scale = (width_m / 2.0, height_m / 2.0, 1.0)
Â  Â  Â  Â  Â  bpy.ops.object.transform_apply(scale=True)
Â  Â  Â  Â  Â  panel.rotation_euler[0] = math.radians(90)
Â  Â  Â  Â  Â  bpy.ops.object.transform_apply(rotation=True)

Â  Â  Â  Â  Â  mesh = panel.data
Â  Â  Â  Â  Â  mat_artwork = bpy.data.materials.new("ArtworkMaterial")
Â  Â  Â  Â  Â  mat_artwork.use_nodes = True
Â  Â  Â  Â  Â  nodes = mat_artwork.node_tree.nodes
Â  Â  Â  Â  Â  bsdf = nodes.get("Principled BSDF")
Â  Â  Â  Â  Â  tex_node = nodes.new("ShaderNodeTexImage")
Â  Â  Â  Â  Â  tex_node.image = img
Â  Â  Â  Â  Â  mat_artwork.node_tree.links.new(tex_node.outputs['Color'], bsdf.inputs['Base Color'])
Â  Â  Â  Â  Â  mesh.materials.append(mat_artwork)

Â  Â  Â  Â  Â  bpy.ops.object.select_all(action='DESELECT')
Â  Â  Â  Â  Â  panel.select_set(True)
Â  Â  Â  Â  Â  bpy.context.view_layer.objects.active = panel

Â  Â  Â  Â  Â  print(f"ğŸ“¦ Exporting GLB to {out_glb}...")
Â  Â  Â  Â  Â  bpy.ops.export_scene.gltf(filepath=out_glb, export_format='GLB', use_selection=True, export_yup=True)
Â  Â  Â  Â  Â  print("âœ… GLB export complete.")

Â  Â  Â  Â  Â  print(f"ğŸ“¦ Exporting USDZ to {out_usdz}...")
Â  Â  Â  Â  Â  bpy.ops.wm.usd_export(filepath=out_usdz, selected_objects_only=True, export_textures=True, relative_paths=False)
Â  Â  Â  Â  Â  print("âœ… USDZ export complete.")
Â  Â  Â  Â  Â  PY

Â  Â  Â  - name: Run Blender headless
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  ARIP_IMAGE_PATH: ${{ github.workspace }}/assets/artwork.jpg
Â  Â  Â  Â  Â  ARIP_OUT_GLB:Â  Â ${{ github.workspace }}/output/artwork.glb
Â  Â  Â  Â  Â  ARIP_OUT_USDZ:Â  ${{ github.workspace }}/output/artwork.usdz
Â  Â  Â  Â  run: blender/blender.app/Contents/MacOS/Blender -b -noaudio --python scripts/make_ar_plane.py

Â  Â  Â  - name: Normalize and stage artifacts
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  set -euxo pipefail
Â  Â  Â  Â  Â  mkdir -p public_models
Â  Â  Â  Â  Â  cp output/artwork.glb public_models/artwork.glb
Â  Â  Â  Â  Â  cp output/artwork.usdz public_models/artwork.usdz

Â  Â  Â  - name: Commit artifacts to repo
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git config user.name "github-actions[bot]"
Â  Â  Â  Â  Â  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
Â  Â  Â  Â  Â  git add public_models
Â  Â  Â  Â  Â  git commit -m "Add AR models for ${{ github.event.client_payload.title }}" || echo "No changes to commit"
Â  Â  Â  Â  Â  git push

Â  Â  Â  - name: POST back to WordPress (after HEAD check)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  GLB_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/public_models/artwork.glb"
Â  Â  Â  Â  Â  USDZ_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/public_models/artwork.usdz"

Â  Â  Â  Â  Â  # Wait for files to be available on GitHub's CDN
Â  Â  Â  Â  Â  for i in {1..10}; do
Â  Â  Â  Â  Â  Â  if curl -sfI "$GLB_URL" > /dev/null; then echo "âœ… GLB is live"; break; fi
Â  Â  Â  Â  Â  Â  echo "â³ Waiting for GLB to propagate..."; sleep 3
Â  Â  Â  Â  Â  done

Â  Â  Â  Â  Â  # This jq command now includes the job_id from the client_payload.
Â  Â  Â  Â  Â  jq -n \
Â  Â  Â  Â  Â  	--arg post_id "${{ github.event.client_payload.post_id }}" \
Â  Â  Â  Â  Â  	--arg title "${{ github.event.client_payload.title }}" \
Â  Â  Â  Â  Â  	--arg glb_url "$GLB_URL" \
Â  Â  Â  Â  _ --arg usdz_url "$USDZ_URL" \
Â  Â  Â  Â  Â  	--arg job_id "${{ github.event.client_payload.job_id }}" \
Â  Â  Â  Â  Â  	'{post_id: $post_id, title: $title, glb_url: $glb_url, usdz_url: $usdz_url, job_id: $job_id}' \
Â  Â  Â  Â  Â  | curl -v -X POST "${{ github.event.client_payload.webhook_url }}" \
Â  Â  Â  Â  Â  	-H "Authorization: Bearer ${{ github.event.client_payload.webhook_token }}" \
Â  Â  Â  Â  Â  	-H "Content-Type: application/json" \
Â  Â  Â  Â  Â  	-d @-
